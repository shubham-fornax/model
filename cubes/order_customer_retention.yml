#
#cubes:
#  - name: customer_first_order
#    sql: >
#      with first_order_details_per_customer as (
#
#        select customer_id, sku_name, dp.product_name, dp.category, dense_rank() over (partition by customer_id order by order_date asc) as rn
#        from thewhitewillow_ocular_production.fact_order_item as foi
#        left join thewhitewillow_ocular_gsheets_integration.dim_products as dp
#        on foi.sku_name = dp.sku )
#
#      select *, row_number() over (partition by customer_id) as rn_cust
#      from first_order_details_per_customer where rn  = 1
#    description: This cube is defined on top of fact_order_item and fetched the sku level details of the first order for all customers.
#
#    segments:
#
#      - name: distinct_customer
#        sql: "{CUBE}.rn_cust = 1"
#
#    joins:
#
#      - name: retention
#        relationship: one_to_many
#        sql: "{CUBE}.customer_id = {retention.customer_id}"
#
#
#    dimensions:
#
#      - name: customer_id
#        sql: "customer_id"
#        type: string
#        description: customer_id associated with the order.
#
#      - name: product_name
#        sql: product_name
#        type: string
#        description: Product_name of the SKU ordered in the first order for a customer. It is fetched from the dim_products table.
#
#      - name: category
#        sql: catgeory
#        type: string
#        description: category of the SKU ordered in the first order for a customer. It is fetched from the dim_products table.
#
#
#      - name: sku_name
#        sql: sku_name
#        type: string
#        description: sku_name of the SKU ordered in the first order for a customer. It is fetched from the dim_products table.
#
#
#
#  - name: retention
#    sql:  >
#           select distinct * from thewhitewillow_ocular_production.fact_order_item
#    description: This cube contains necessary measure and dimensions for order and customer retention profiles.
#      It is built on fact_order_item and the customer level information is fetched by performing a join with the
#      dim_customer_profile table, on customer_id.
#    data_source: default
#
#    segments:
#
##    pre_aggregations:
##      - name: monthly_revenue
##        dimensions:
##          - retention.order_month
##        measures:
##          - retention.revenue
##        time_dimension: retention.order_date
##        granularity: month
##        type: rollup
#
#    joins:
#
#      - name: dim_customer_profile
#        relationship: many_to_one
#        sql: "cast({CUBE}.customer_id as string) = {dim_customer_profile.customer_id}"
#
##      - name: dim_date_customer_created
##        relationship: many_to_one
##        sql: "cast({CUBE}.customer_created_at as date) = {dim_date_customer_created.full_date}"
#
#      - name: dim_products
#        relationship: many_to_one
#        sql: "cast({CUBE}.sku_name as string) = {dim_products.sku}"
#
#      - name: dim_date_orders
#        relationship: many_to_one
#        sql: "cast({CUBE}.order_date as date) = {dim_date_orders.full_date}"
##        description: This join enables to fetch dim_date columns for the customer_created_at column.
#
#    dimensions:
#
#      - name: composite_key
#        sql: CONCAT(order_id, '-', order_item)
#        description: A composite_key to act as a primary key. Based on the smallest grain - order_id and order_item_id
#        type: string
#        primary_key: true
#
#      - name: order_id
#        sql: order_id
#        description: ID of an order as per the sales channel
#        type: string
#
#      - name: order_item_id
#        sql: order_item_id
#        description: ID of an item inside an order, based on the sales channel
#        type: string
#
#      - name: marketplace
#        sql: marketplace
#        description: The channel where the order was processed.
#        type: string
#
#      - name: customer_id
#        sql: customer_id
#        description: ID of the customer who placed the order. It is currently generated by the marketplace/channel
#        type: string
#
#      - name: order_date
#        sql: order_date
#        description: The timestamp when the order was placed on the marketplace website.
#        type: time
#
#      - name: order_week
#        sql: "{dim_date_orders.year_week}"
#        description: The week number when the order was placed.  This is extracted from the order_date column and week number is extracted from dim_date.
#        type: number
#
#      - name: order_month
#        sql: "{dim_date_orders.month}"
#        description: The month number when the order was placed.  This is extracted from the order_date column and month number is extracted from dim_date.
#        type: number
#
#      - name: order_quarter
#        sql: "{dim_date_orders.calender_quarter}"
#        description: The quarter number when the order was placed.  This is extracted from the order_date column  and quarter number is extracted from dim_date.
#        type: number
#
#      - name: order_year
#        sql: "{dim_date_orders.calender_year}"
#        description: The year number when the order was placed.  This is extracted from the order_date column  and quarter number is extracted from dim_date.
#        type: number
#
#      - name: customer_created_at
#        sql: customer_created_at
#        description: The timestamp when a particular customer was created on the website of the marketplace.
#        type: time
#
##      - name: customer_created_week
##        sql: "{dim_date_customer_created.year_week}"
##        description: The week number when the customer was created.  This is extracted from the order_date column.
##        type: number
##
##      - name: customer_created_month
##        sql: "{dim_date_customer_created.month}"
##        description: The month number when the customer was created. This is extracted from the customer_created_at column
##        type: number
##
##      - name: customer_created_quarter
##        sql: "{dim_date_customer_created.calender_quarter}"
##        description: The quarter number when the customer was created. This is extracted from the customer_created_at column
##        type: number
##
##      - name: customer_created_year
##        sql: "{dim_date_customer_created.calender_year}"
##        description: The year number when the customer was created. This is extracted from the customer_created_at column
##        type: number
#
#      - name: first_order_date
#        sql: "{dim_customer_profile.first_order_date}"
#        description: This is the date when the first order was made by that particular customer. It is fetched from dim_customer_profile table.
#        type: time
#
#      - name: first_order_week
#        sql: "{dim_date_customer_first_order.year_week}"
#        description: This is the week when the first order was made by that particular customer. It is fetched from dim_customer_profile table and week number is extracted from dim_date table.
#        type: number
#
#      - name: first_order_month
#        sql: "{dim_date_customer_first_order.month}"
#        description: This is the month when the first order was made by that particular customer. It is fetched from dim_customer_profile table and month number is extracted from dim_date table.
#        type: number
#
#      - name: first_order_quarter
#        sql: "{dim_date_customer_first_order.calender_quarter}"
#        description: This is the quarter when the first order was made by that particular customer. It is fetched from dim_customer_profile table and quarter number is extracted from dim_date table.
#        type: number
#
#      - name: first_order_year
#        sql: "{dim_date_customer_first_order.calender_year}"
#        description: This is the year when the first order was made by that particular customer. It is fetched from dim_customer_profile table and year number is extracted from dim_date table.
#        type: number
#
#      - name: item_price
#        sql: item_price
#        description: The total price paid for the item in the order.
#        type: number
#
#      - name: order_price
#        sql: order_price
#        description: The total price paid for the order.
#        type: number
#
#      - name: order_cost
#        sql: order_cost
#        description: The total cost for the order.
#        type: number
#
#      - name: sku
#        sql: "{dim_products.sku}"
#        type: string
#
#      - name: product_name
#        sql:  "{dim_products.product_name}"
#        description: The name of the product.
#        type: number
#
#      - name: category
#        sql: "{dim_products.category}"
#        description: The main category to which the items in this order belong.
#        type: string
#
#      - name: sub_category
#        sql: sub_category
#        description: The sub-category to which the items in this order belong.
#        type: string
#
#      - name: retention_quarter
#        sql: " 4*({dim_date_orders.calender_year} - {dim_date_customer_first_order.calender_year}) + ({dim_date_orders.calender_quarter} - {dim_date_customer_first_order.calender_quarter} )"
#        description: The number of quarters between the starting quarter of the cohort and the order quarter.
#        type: number
#
#      - name: retention_month
#        sql: " 12*({dim_date_orders.calender_year} - {dim_date_customer_first_order.calender_year}) + ({dim_date_orders.month} - {dim_date_customer_first_order.month} )"
#        description: The number of months  between the starting month of the cohort and the order month
#        type: number
#
#      - name: retention_week
#        sql: " 52*({dim_date_orders.calender_year} - {dim_date_customer_first_order.calender_year}) + ({dim_date_orders.year_week} - {dim_date_customer_first_order.year_week})"
#        description: The number of weeks  between the starting week of the cohort and the order week
#        type: number
#
#      - name: age_month_year
#        sql: "{dim_date_customer_first_order.month_year_combo}"
#        description: The month-year extracted from the first order date column. This column contains the cohort definition.
#        type: string
#
#      - name: age_week_year
#        sql: "{dim_date_customer_first_order.week_year_combo}"
#        description: The week-year extracted from the first order date column. This column contains the cohort definition.
#        type: string
#
#      - name: age_quarter_year
#        sql: "{dim_date_customer_first_order.quarter_year_combo}"
#        description: The quarter-year extracted from the first order date column . This column contains the cohort definition.
#        type: string
#
#    measures:
#      - name: count_distinct_order_id
#        sql: order_id
#        description: The distinct count of order_id.
#        type: countDistinct
#        drill_members:
#          - order_id
#          - marketplace
#          - order_date
#          - order_price
#          - order_cost
#          - product_name
#          - category
#          - sub_category
#
#      - name: count_customer_id
#        sql: customer_id
#        description: The distinct count of customer_ids.
#        type: countDistinct
#
#      - name: count_order_id
#        sql: order_id
#        description: The count of order_ids.
#        type: count
#
#      - name: revenue
#        sql: item_price
#        description: The revenue generated from the order. It is calculated by taking sum of item_price.
#        type: sum
#
##      - name: month_revenue_1
##        sql: "monthly_revenue.monthly_revenue"
##        type: number
##        filters:
##          - sql: "monthly_revenue.order_month = 1"
#
#  - name: dim_products
#    sql_table: thewhitewillow_ocular_gsheets_integration.dim_products
#    description: This cube contains dimensional information about products.
#
#    dimensions:
#
#      - name: sku
#        sql: sku
#        type: string
#        description: The sku name of the product in  the dim_products table
#
#      - name: category
#        sql: category
#        type: string
#        description: The category name of the product in the dim_products table
#
#      - name: product_name
#        sql: product_name
#        type: string
#        description: The product name of the product in the dim_products table
#
#      - name: asin
#        sql: asin
#        type: string
#        description: The asin name of the product in the dim_products table
#
#
#  - name: dim_customer_profile
#    sql_table: thewhitewillow_ocular_production.dim_customer_profile
#    description: This cube contains relevant dimensional customer info based on the dim_customer_profile table.
#    data_source: default
#
#    joins:
#
#      - name: dim_date_customer_first_order
#        relationship: many_to_one
#        sql: "cast({dim_customer_profile.first_order_date} as date) = {dim_date_customer_first_order.full_date}"
#
#    dimensions:
#      - name: customer_id
#        sql: customer_id
#        type: string
#        description: The customer_id of the product in the dim_products table
#
#      - name: first_order_date
#        sql: first_order_date
#        type: time
#        description: The order date of the first order placed by the customer
#
#      - name: proxy_first_order_month
#        sql: "extract(month from first_order_date)"
#        type: time
#
#      - name: total_amount_spent_till_date
#        sql: total_amount_spent_till_date
#        type: number
#
#  - name: dim_date_orders
#    sql_table: ocular_reports.dim_date
#    sql_alias: dim_date_orders
#    description: This table contains the dimensional information about the date.
#
#    dimensions:
#      - name: calender_year
#        sql: calender_year
#        type: number
#        description: The calender year number for the date.
#
#      - name: month
#        sql: month
#        type: number
#        description: The calender month number for the date.
#
#      - name: year_week
#        sql: year_week
#        type: number
#        description: The calender weak number in a calender year for the date.
#
#      - name: calender_quarter
#        sql: calender_quarter
#        type: number
#        description: The calender quarter number in a calender year for the date.
#
#      - name: full_date
#        sql: full_date
#        type: time
#
#      - name: week_year_combo
#        sql: week_year_combo
#        type: string
#        description: The week year combination for the date.
#
#      - name: month_year_combo
#        sql: month_year_combo
#        type: string
#        description: The month year combination for the date.
#
#
#      - name: quarter_year_combo
#        sql: quarter_year_combo
#        type: string
#
#
#  - name: dim_date_customer_first_order
#    sql_table: ocular_reports.dim_date
#    sql_alias: dim_date_customer_first_order
#    description: This table contains the dimensional information about the date.
#    data_source: default
#
#    joins: []
#
#    dimensions:
#      - name: calender_year
#        sql: calender_year
#        type: number
#        description: The calender year number for the date.
#
#      - name: month
#        sql: month
#        type: number
#        description: The calender month number for the date.
#
#      - name: year_week
#        sql: year_week
#        type: number
#
#      - name: calender_quarter
#        sql: calender_quarter
#        type: number
#
#      - name: full_date
#        sql: full_date
#        type: time
#        primary_key: true
#
#      - name: week_year_combo
#        sql: week_year_combo
#        type: string
#
#      - name: month_year_combo
#        sql: month_year_combo
#        type: string
#
#      - name: quarter_year_combo
#        sql: quarter_year_combo
#        type: string
#
##  - name: dim_date_customer_created
##    sql_table: ocular_reports.dim_date
##    sql_alias: dim_date_customer_created
##    description: This table contains the dimensional information about the date.
##    data_source: default
##
##    joins: [ ]
##
##    dimensions:
##      - name: calender_year
##        sql: calender_year
##        type: number
##
##      - name: month
##        sql: month
##        type: number
##
##      - name: year_week
##        sql: year_week
##        type: number
##
##      - name: calender_quarter
##        sql: calender_quarter
##        type: number
##
##      - name: full_date
##        sql: full_date
##        type: time
##
##      - name: week_year_combo
##        sql: week_year_combo
##        type: string
##
##      - name: month_year_combo
##        sql: month_year_combo
##        type: string
##
##      - name: quarter_year_combo
##        sql: quarter_year_combo
##        type: string
#
